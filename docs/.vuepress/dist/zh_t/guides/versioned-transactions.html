<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.36">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <meta name="title" content="Solana祕籍| Versioned Transactions"><meta name="og:title" content="Solana祕籍| Versioned Transactions"><meta name="description" content="New and improved transaction format on Solana."><meta name="og:description" content="New and improved transaction format on Solana."><meta name="og:image" content="https://solanacookbook.com/cookbook-sharing-card.png"><meta name="og:image:alt" content="Solana splash card"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@solanacookbook"><meta name="twitter:image" content="https://solanacookbook.com/cookbook-sharing-card.png"><meta name="robots" content="index,follow,noodp"><meta name="googlebot" content="index,follow"><link rel="icon" href="/solana_cookbook_lightmode.svg"><script data-domain="solanacookbook.com" src="https://plausible.io/js/plausible.js"></script><title>版本化交易 (Versioned Transactions) | Solana Cookbook</title>
    <link rel="modulepreload" href="/assets/app.07ce7a66.js"><link rel="modulepreload" href="/assets/versioned-transactions.html.027ceb3d.js"><link rel="modulepreload" href="/assets/versioned-transactions.html.1e457979.js">
    <link rel="stylesheet" href="/assets/style.fecd2c41.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/" class=""><!----><span class="site-name can-hide">Solana Cookbook</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a class="external-link" href="https://github.com/solana-developers/solana-cookbook" rel="noopener noreferrer" target="_blank" aria-label="Contribute"><!--[--><!--]--> Contribute <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/zh_t/guides/versioned-transactions.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/zh/" class="" aria-label="中文（简体）"><!--[--><!--]--> 中文（简体） <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/es/" class="" aria-label="Spanish"><!--[--><!--]--> Spanish <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/pt/" class="" aria-label="Português"><!--[--><!--]--> Português <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/de/" class="" aria-label="Deutsch"><!--[--><!--]--> Deutsch <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/vi/" class="" aria-label="Tiếng Việt"><!--[--><!--]--> Tiếng Việt <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/th/" class="" aria-label="ไทย"><!--[--><!--]--> ไทย <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/fr/" class="" aria-label="Français"><!--[--><!--]--> Français <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/id/" class="" aria-label="Bahasa Indonesia"><!--[--><!--]--> Bahasa Indonesia <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/kr/" class="" aria-label="한국어"><!--[--><!--]--> 한국어 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/tr/" class="" aria-label="Türkçe"><!--[--><!--]--> Türkçe <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ja/" class="" aria-label="日本語"><!--[--><!--]--> 日本語 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/fil/" class="" aria-label="Filipino"><!--[--><!--]--> Filipino <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a class="external-link" href="https://github.com/solana-developers/solana-cookbook" rel="noopener noreferrer" target="_blank" aria-label="Contribute"><!--[--><!--]--> Contribute <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a aria-current="page" href="/zh_t/guides/versioned-transactions.html" class="router-link-active router-link-exact-active router-link-active" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/zh/" class="" aria-label="中文（简体）"><!--[--><!--]--> 中文（简体） <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/es/" class="" aria-label="Spanish"><!--[--><!--]--> Spanish <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/pt/" class="" aria-label="Português"><!--[--><!--]--> Português <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/de/" class="" aria-label="Deutsch"><!--[--><!--]--> Deutsch <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/vi/" class="" aria-label="Tiếng Việt"><!--[--><!--]--> Tiếng Việt <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/th/" class="" aria-label="ไทย"><!--[--><!--]--> ไทย <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/fr/" class="" aria-label="Français"><!--[--><!--]--> Français <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/id/" class="" aria-label="Bahasa Indonesia"><!--[--><!--]--> Bahasa Indonesia <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/kr/" class="" aria-label="한국어"><!--[--><!--]--> 한국어 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/tr/" class="" aria-label="Türkçe"><!--[--><!--]--> Türkçe <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ja/" class="" aria-label="日本語"><!--[--><!--]--> 日本語 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/fil/" class="" aria-label="Filipino"><!--[--><!--]--> Filipino <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">Getting Started <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/" class="sidebar-item" aria-label="Cooking with Solana"><!--[--><!--]--> Cooking with Solana <!--[--><!--]--></a><!----></li><li><a href="/getting-started/installation.html" class="sidebar-item" aria-label="Installation"><!--[--><!--]--> Installation <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">Core Concepts <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/core-concepts/accounts.html" class="sidebar-item" aria-label="Accounts"><!--[--><!--]--> Accounts <!--[--><!--]--></a><!----></li><li><a href="/core-concepts/programs.html" class="sidebar-item" aria-label="Programs"><!--[--><!--]--> Programs <!--[--><!--]--></a><!----></li><li><a href="/core-concepts/transactions.html" class="sidebar-item" aria-label="Transactions"><!--[--><!--]--> Transactions <!--[--><!--]--></a><!----></li><li><a href="/core-concepts/pdas.html" class="sidebar-item" aria-label="Program Derived Addresses (PDAs)"><!--[--><!--]--> Program Derived Addresses (PDAs) <!--[--><!--]--></a><!----></li><li><a href="/core-concepts/cpi.html" class="sidebar-item" aria-label="Cross Program Invocations (CPIs)"><!--[--><!--]--> Cross Program Invocations (CPIs) <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">Guides <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/guides/get-program-accounts.html" class="sidebar-item" aria-label="Get Program Accounts"><!--[--><!--]--> Get Program Accounts <!--[--><!--]--></a><!----></li><li><a href="/guides/serialization.html" class="sidebar-item" aria-label="Serializing Data"><!--[--><!--]--> Serializing Data <!--[--><!--]--></a><!----></li><li><a href="/guides/data-migration.html" class="sidebar-item" aria-label="Migrating Program Data Accounts"><!--[--><!--]--> Migrating Program Data Accounts <!--[--><!--]--></a><!----></li><li><a href="/guides/account-maps.html" class="sidebar-item" aria-label="Account Maps"><!--[--><!--]--> Account Maps <!--[--><!--]--></a><!----></li><li><a href="/guides/debugging-solana-programs.html" class="sidebar-item" aria-label="Debugging Solana Programs"><!--[--><!--]--> Debugging Solana Programs <!--[--><!--]--></a><!----></li><li><a href="/guides/feature-parity-testing.html" class="sidebar-item" aria-label="Feature Parity Testing"><!--[--><!--]--> Feature Parity Testing <!--[--><!--]--></a><!----></li><li><a href="/guides/versioned-transactions.html" class="sidebar-item" aria-label="Versioned Transactions"><!--[--><!--]--> Versioned Transactions <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">References <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/references/local-development.html" class="sidebar-item" aria-label="Local Development"><!--[--><!--]--> Local Development <!--[--><!--]--></a><!----></li><li><a href="/references/keypairs-and-wallets.html" class="sidebar-item" aria-label="Keypairs and Wallets"><!--[--><!--]--> Keypairs and Wallets <!--[--><!--]--></a><!----></li><li><a href="/references/basic-transactions.html" class="sidebar-item" aria-label="Sending Transactions"><!--[--><!--]--> Sending Transactions <!--[--><!--]--></a><!----></li><li><a href="/references/accounts.html" class="sidebar-item" aria-label="Accounts"><!--[--><!--]--> Accounts <!--[--><!--]--></a><!----></li><li><a href="/references/programs.html" class="sidebar-item" aria-label="Writing Programs"><!--[--><!--]--> Writing Programs <!--[--><!--]--></a><!----></li><li><a href="/references/token.html" class="sidebar-item" aria-label="Interacting with Tokens"><!--[--><!--]--> Interacting with Tokens <!--[--><!--]--></a><!----></li><li><a href="/references/staking.html" class="sidebar-item" aria-label="Staking"><!--[--><!--]--> Staking <!--[--><!--]--></a><!----></li><li><a href="/references/nfts.html" class="sidebar-item" aria-label="NFTs"><!--[--><!--]--> NFTs <!--[--><!--]--></a><!----></li><li><a href="/references/offline-transactions.html" class="sidebar-item" aria-label="Sending Offline Transactions"><!--[--><!--]--> Sending Offline Transactions <!--[--><!--]--></a><!----></li><li><a href="/references/name-service.html" class="sidebar-item" aria-label="Name Service"><!--[--><!--]--> Name Service <!--[--><!--]--></a><!----></li><li><p tabindex="0" class="sidebar-item collapsible">Gaming <span class="right arrow"></span></p><!--[--><ul style="display:none;" class="sidebar-item-children"><!--[--><li><a href="/gaming/intro.html" class="sidebar-item" aria-label="Introduction to Gaming on Solana"><!--[--><!--]--> Introduction to Gaming on Solana <!--[--><!--]--></a><!----></li><li><a href="/gaming/game-sdks.html" class="sidebar-item" aria-label="Solana Gaming SDKs"><!--[--><!--]--> Solana Gaming SDKs <!--[--><!--]--></a><!----></li><li><a href="/gaming/nfts-in-games.html" class="sidebar-item" aria-label="Gaming with NFTs"><!--[--><!--]--> Gaming with NFTs <!--[--><!--]--></a><!----></li><li><a href="/gaming/hello-world.html" class="sidebar-item" aria-label="Hello World example"><!--[--><!--]--> Hello World example <!--[--><!--]--></a><!----></li><li><a href="/gaming/store-sol-in-pda.html" class="sidebar-item" aria-label="Storing SOL in a PDA"><!--[--><!--]--> Storing SOL in a PDA <!--[--><!--]--></a><!----></li><li><a href="/gaming/saving-game-state.html" class="sidebar-item" aria-label="Saving game state"><!--[--><!--]--> Saving game state <!--[--><!--]--></a><!----></li><li><a href="/gaming/energy-system.html" class="sidebar-item" aria-label="Energy System"><!--[--><!--]--> Energy System <!--[--><!--]--></a><!----></li><li><a href="/gaming/interact-with-tokens.html" class="sidebar-item" aria-label="How interact with tokens in programs"><!--[--><!--]--> How interact with tokens in programs <!--[--><!--]--></a><!----></li><li><a href="/gaming/porting-anchor-to-unity.html" class="sidebar-item" aria-label="Port Anchor to Unity"><!--[--><!--]--> Port Anchor to Unity <!--[--><!--]--></a><!----></li><li><a href="/gaming/distribution.html" class="sidebar-item" aria-label="Distribution"><!--[--><!--]--> Distribution <!--[--><!--]--></a><!----></li><li><a href="/gaming/game-examples.html" class="sidebar-item" aria-label="Learn By Example"><!--[--><!--]--> Learn By Example <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="版本化交易-versioned-transactions" tabindex="-1"><a class="header-anchor" href="#版本化交易-versioned-transactions" aria-hidden="true">#</a> 版本化交易 (Versioned Transactions)</h1><p>Solana最近發佈了版本化交易。提議的更改如下：</p><ol><li><p>引入一個新的程序，用於管理鏈上地址查找表。</p></li><li><p>添加一種新的交易格式，可以利用鏈上地址查找表。</p></li></ol><h2 id="綜述" tabindex="-1"><a class="header-anchor" href="#綜述" aria-hidden="true">#</a> 綜述</h2><div class="custom-container tip"><p class="custom-container-title">事實表</p><p>-傳統交易存在一個主要問題：最大允許的大小爲1232字節，因此原子交易中可以容納的賬戶數量爲35個地址。</p><ul><li>地址查找表（LUTs）：一旦賬戶存儲在該表中，可以使用1字節的u8索引，在交易消息中引用該表的地址。</li><li>可以使用<code>solana/web3.js</code>的<code>createLookupTable()</code>構建一個新的查找表，並確定其地址。</li><li>一旦創建了LUT，可以進行擴展，即可以將賬戶追加到表中。</li><li>版本化交易：需要修改傳統交易的結構以整合LUTs。</li><li>在引入版本化之前，交易在其頭部的第一個字節中保留了一個未使用的最高位，可以用來顯式聲明交易的版本。</li></ul></div><p>我們將更詳細地討論上述引入的更改以及它們對開發人員的意義。然而，爲了更好地理解這些更改，我們首先需要了解常規（或傳統）交易的結構。</p><h2 id="傳統交易-legacy-transactions" tabindex="-1"><a class="header-anchor" href="#傳統交易-legacy-transactions" aria-hidden="true">#</a> 傳統交易（Legacy Transactions）</h2><p>Solana網絡使用最大事務單元（MTU）大小爲1280字節，遵循<a href="https://en.wikipedia.org/wiki/IPv6_packet" target="_blank" rel="noopener noreferrer">IPv6 MTU<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 的大小約束，以確保速度和可靠性。這樣留下了1232字節的數據空間，用於存儲序列化的交易等數據。</p><p>一個交易由以下組成：</p><ol><li>一個緊湊數組的簽名，其中每個簽名是一個64字節的<a href="https://ed25519.cr.yp.to/" target="_blank" rel="noopener noreferrer">ed25519<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a>簽名。</li><li>一個（傳統的）消息。</li></ol><p><img src="/assets/tx_format.1023848a.png" alt="Transaction Format"></p><div class="custom-container tip"><p class="custom-container-title">Compact-Array format</p><p>A compact array is an array serialised to have the following components:</p><ol><li>An array length in a multi-byte encoding called <a href="https://beta.docs.solana.com/developing/programming-model/transactions#compact-u16-format" target="_blank" rel="noopener noreferrer">Compact-u16<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li>Followed by each array item</li></ol><p><img src="/assets/compact_array_format.6984243f.png" alt="Compact array format"></p></div><h2 id="傳統消息" tabindex="-1"><a class="header-anchor" href="#傳統消息" aria-hidden="true">#</a> 傳統消息</h2><p>傳統消息包含以下組件：</p><ol><li>一個頭部（header）。</li><li>一個緊湊數組的賬戶地址，每個賬戶地址佔用32字節。</li><li>一個最近的區塊哈希（recent blockhash）： <ul><li>一個32字節的SHA-256哈希，用於指示上次觀察到的賬本狀態。如果一個區塊哈希太舊，驗證節點將拒絕它。</li></ul></li><li>一個緊湊數組的指令</li></ol><p><img src="/assets/legacy_message.09ab30b7.png" alt="Legacy Message"></p><h3 id="頭部" tabindex="-1"><a class="header-anchor" href="#頭部" aria-hidden="true">#</a> 頭部</h3><p>消息頭部是3字節長，包含3個u8整數：</p><ol><li>所需簽名數量：Solana運行時會將此數字與交易中緊湊數組簽名的長度進行驗證。</li><li>需要簽名的只讀賬戶地址數量。</li><li>不需要簽名的只讀賬戶地址數量。</li></ol><p><img src="/assets/message_header.8eb7d589.png" alt="Message Header"></p><h3 id="緊湊賬戶地址數組" tabindex="-1"><a class="header-anchor" href="#緊湊賬戶地址數組" aria-hidden="true">#</a> 緊湊賬戶地址數組</h3><p>這個緊湊數組以緊湊的u16編碼的賬戶地址數量開始，然後是：</p><ol><li><strong>需要簽名的賬戶地址</strong>：首先列出請求讀取和寫入訪問權限的地址，然後是請求只讀訪問權限的地址。</li><li><strong>不需要簽名的賬戶地址</strong>：與上述相同，首先列出請求讀取和寫入訪問權限的地址，然後是請求只讀訪問權限的地址。</li></ol><p><img src="/assets/compat_array_of_account_addresses.7792e5c7.png" alt="Compact array of account addresses"></p><h3 id="緊湊指令數組" tabindex="-1"><a class="header-anchor" href="#緊湊指令數組" aria-hidden="true">#</a> 緊湊指令數組</h3><p>就像賬戶地址數組一樣，這個緊湊指令數組以緊湊的u16編碼的指令數量開始，然後是一個指令數組。數組中的每個指令具有以下組件：</p><ol><li><strong>程序ID</strong>：用於標識將處理該指令的鏈上程序。它表示爲消息中賬戶地址緊湊數組的地址的u8索引。</li><li><strong>賬戶地址索引的緊湊數組</strong>：指向緊湊賬戶地址數組中需要簽名的一部分賬戶地址的u8索引。</li><li><strong>不透明的u8數據的緊湊數組</strong>：一個通用的字節數組，與前面提到的程序ID相關。該數據數組指定了程序應執行的任何操作以及賬戶可能不包含的任何附加信息。</li></ol><p><img src="/assets/compact_array_of_ixs.6281d70b.png" alt="Compact array of Instructions"></p><h2 id="傳統交易的問題" tabindex="-1"><a class="header-anchor" href="#傳統交易的問題" aria-hidden="true">#</a> 傳統交易的問題</h2><p>上述交易模型存在的問題是什麼?</p><p>交易的最大大小以及因此能夠在單個原子交易中容納的賬戶數量。</p><p>如前所述，交易的最大允許大小爲1232字節。一個賬戶地址的大小爲32字節。因此，考慮到一些用於頭部、簽名和其他元數據的空間，一個交易最多隻能存儲35個賬戶。</p><p><img src="/assets/issues_with_legacy_txs.5766db66.png" alt="Issue with legacy transactions"></p><p>這是一個問題，因爲有幾種情況下，開發人員需要在單個交易中包含數百個無需簽名的賬戶。但是，傳統交易模型目前無法實現這一點。目前使用的解決方案是在鏈上臨時存儲狀態，並在稍後的交易中使用。但是，當多個程序需要組合在單個交易中時，這種解決方法就不適用了。每個程序都需要多個賬戶作爲輸入，因此我們陷入了與之前相同的問題。</p><p>這就是引入**地址查找表（Address Lookup Tables，LUT）**的原因。</p><h2 id="地址查找表-address-lookeup-tables" tabindex="-1"><a class="header-anchor" href="#地址查找表-address-lookeup-tables" aria-hidden="true">#</a> 地址查找表(Address Lookeup Tables)</h2><p>地址查找表的理念是在鏈上使用表格（數組）的數據結構存儲賬戶地址。一旦賬戶存儲在該表中，可以在交易消息中引用該表的地址。爲了指向表中的單個賬戶，需要使用一個字節的u8索引。</p><p><img src="/assets/luts.96a8a310.png" alt="LUTs"></p><p>這樣做可以節省空間，因爲地址不再需要存儲在交易消息中。它們只需要以數組形式的表格中的索引進行引用。這使得有可能引用256個賬戶，因爲賬戶使用u8索引進行引用。</p><p>當初始化地址查找表或向表中添加新地址時，需要使地址查找表免除租金。地址可以通過鏈上緩衝區或直接通過<code>Extension</code>指令將其追加到表格中。此外，地址查找表還可以存儲相關的元數據，後面是一個緊湊數組的賬戶。下面是一個典型地址查找表的結構：</p><p><img src="/assets/lut_format.060d6be2.png" alt="LUT Format"></p><p>地址查找表的一個重要缺點是，在交易處理過程中，由於地址查找需要額外的開銷，通常會導致交易的成本較高。</p><h2 id="版本化交易-transactionv0" tabindex="-1"><a class="header-anchor" href="#版本化交易-transactionv0" aria-hidden="true">#</a> 版本化交易： TransactionV0</h2><p>傳統交易的結構需要修改以包含地址表查找。這些更改不應破壞Solana上的交易處理，也不應對被調用的程序的格式產生任何更改。</p><p>爲了確保上述情況，重要的是明確指出交易類型：<code>legacy</code>（傳統）或<code>versioned</code>（版本化）。我們如何在交易中包含這些信息呢？</p><p>在引入版本化之前，交易在其消息頭部的<code>num_required_signatures</code>字段的第一個字節中留下了一個未使用的上位比特。現在，我們可以使用這個比特位來明確聲明我們的交易版本。</p><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">VersionedMessage</span> <span class="token punctuation">{</span>
    <span class="token class-name">Legacy</span><span class="token punctuation">(</span><span class="token class-name">Message</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token constant">V0</span><span class="token punctuation">(</span><span class="token namespace">v0<span class="token punctuation">::</span></span><span class="token class-name">Message</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br></div></div><p>如果設置了第一個比特位，那麼第一個字節中的剩餘比特將用於編碼版本號。Solana從“版本0”開始，這是開始使用地址查找表的版本。</p><p>如果未設置第一個比特位，那麼該交易將被視爲“傳統交易”，並且第一個字節的剩餘部分將被視爲編碼傳統消息的第一個字節。</p><h2 id="messagev0" tabindex="-1"><a class="header-anchor" href="#messagev0" aria-hidden="true">#</a> MessageV0</h2><p>新的MessageV0的結構基本上是相同的，只是有兩個小但重要的變化：</p><ol><li><strong>消息頭部</strong>：與傳統版本相同，沒有變化。</li><li><strong>緊湊賬戶密鑰數組</strong>：與傳統版本相同，沒有變化。我們將指向該數組元素的索引數組表示爲<em>索引數組A</em>（您很快將看到爲什麼我們這樣表示）。</li><li><strong>最近的區塊哈希</strong>：與傳統版本相同，沒有變化。</li><li><strong>緊湊指令數組</strong>：與傳統版本不同，發生了變化。</li><li><strong>地址表查找的緊湊數組</strong>：在版本0中引入。</li></ol><p><img src="/assets/messagev0.c089b240.png" alt="Message v0"></p><p>在查看指令數組中的變化之前，我們首先討論地址表查找的緊湊數組的結構。</p><h3 id="地址表查找的緊湊數組" tabindex="-1"><a class="header-anchor" href="#地址表查找的緊湊數組" aria-hidden="true">#</a> 地址表查找的緊湊數組</h3><p>這個結構將地址查找表（LUT）引入到版本化交易中，從而使得在單個交易中加載更多的只讀和可寫賬戶成爲可能。</p><p>緊湊數組以緊湊的u16編碼表示地址表查找的數量，後跟一個地址表查找的數組。每個查找的結構如下：</p><ol><li><strong>賬戶密鑰</strong>：地址查找表的賬戶密鑰。</li><li><strong>可寫索引</strong>：用於加載可寫賬戶地址的緊湊索引數組。我們將此數組表示爲<em>索引數組B</em>。</li><li><strong>只讀索引</strong>：用於加載只讀賬戶地址的緊湊索引數組。我們將此數組表示爲<em>索引數組C</em>。</li></ol><p><img src="/assets/compact_array_of_luts.9175e491.png" alt="Compact array of LUTs"></p><p>現在讓我們看看指令緊湊數組中做了哪些改變。</p><h3 id="緊湊指令數組-1" tabindex="-1"><a class="header-anchor" href="#緊湊指令數組-1" aria-hidden="true">#</a> 緊湊指令數組</h3><p>如前所述，傳統指令的緊湊數組存儲了各個傳統指令，而這些指令又分別存儲了以下內容：</p><ol><li>程序ID索引</li><li>賬戶地址索引的緊湊數組</li><li>不透明的8位數據的緊湊數組</li></ol><p>新指令中的變化不在於指令本身的結構，而是在於用於獲取第1和第2項索引的數組。在傳統交易中，使用了索引數組A的子集，而在版本化交易中，則使用了以下組合數組的子集：</p><ol><li><strong>索引數組A</strong>：存儲在消息中的緊湊賬戶數組。</li><li><strong>索引數組B</strong>：地址表查找中的可寫索引。</li><li><strong>索引數組C</strong>：地址表查找中的只讀索引。</li></ol><p><img src="/assets/new_compact_array_of_ixs.54090dc5.png" alt="New Compact array of Instructions"></p><h2 id="rpc變更" tabindex="-1"><a class="header-anchor" href="#rpc變更" aria-hidden="true">#</a> RPC變更</h2><p>事務響應將需要一個新的版本字段：<code>maxSupportedTransactionVersion</code>，以向客戶端指示需要遵循的事務結構以進行反序列化。</p><p>以下方法需要進行更新以避免錯誤：</p><ul><li><code>getTransaction</code></li><li><code>getBlock</code></li></ul><p>請求中需要添加以下參數：</p><p><code>maxSupportedTransactionVersion: 0</code></p><p>如果請求中沒有顯式添加<code>maxSupportedTransactionVersion</code>，事務版本將回退到<code>legacy</code>。任何包含版本化事務的區塊，在存在傳統事務的情況下將返回客戶端錯誤。</p><p>你可以通過向RPC端點發送JSON格式的請求來設置如下：</p><div class="language-plaintext ext-plaintext line-numbers-mode"><pre class="language-plaintext"><code>curl http://localhost:8899 -X POST -H &quot;Content-Type: application/json&quot; -d \
&#39;{&quot;jsonrpc&quot;: &quot;2.0&quot;, &quot;id&quot;:1, &quot;method&quot;: &quot;getBlock&quot;, &quot;params&quot;: [430, {
  &quot;encoding&quot;:&quot;json&quot;,
  &quot;maxSupportedTransactionVersion&quot;:0,
  &quot;transactionDetails&quot;:&quot;full&quot;,
  &quot;rewards&quot;:false
}]}&#39;
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>你還可以使用 <a href="https://solana-labs.github.io/solana-web3.js/" target="_blank" rel="noopener noreferrer"><code>@solana/web3.js</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a> 庫執行相同操作。</p><div class="language-javascript ext-js line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// connect to the `devnet` cluster and get the current `slot`</span>
<span class="token keyword">const</span> connection <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">web3<span class="token punctuation">.</span>Connection</span><span class="token punctuation">(</span>web3<span class="token punctuation">.</span><span class="token function">clusterApiUrl</span><span class="token punctuation">(</span><span class="token string">&quot;devnet&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">const</span> slot <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">getSlot</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// get the latest block (allowing for v0 transactions)</span>
<span class="token keyword">const</span> block <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">getBlock</span><span class="token punctuation">(</span>slot<span class="token punctuation">,</span> <span class="token punctuation">{</span>
  <span class="token literal-property property">maxSupportedTransactionVersion</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// get a specific transaction (allowing for v0 transactions)</span>
<span class="token keyword">const</span> getTx <span class="token operator">=</span> <span class="token keyword">await</span> connection<span class="token punctuation">.</span><span class="token function">getTransaction</span><span class="token punctuation">(</span>
  <span class="token string">&quot;3jpoANiFeVGisWRY5UP648xRXs3iQasCHABPWRWnoEjeA93nc79WrnGgpgazjq4K9m8g2NJoyKoWBV1Kx5VmtwHQ&quot;</span><span class="token punctuation">,</span>
  <span class="token punctuation">{</span>
    <span class="token literal-property property">maxSupportedTransactionVersion</span><span class="token operator">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h2 id="其他資料" tabindex="-1"><a class="header-anchor" href="#其他資料" aria-hidden="true">#</a> 其他資料</h2><ul><li><a href="https://beta.docs.solana.com/developing/versioned-transactions#how-create-a-versioned-transaction" target="_blank" rel="noopener noreferrer">如何構建一個版本化事務<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://beta.docs.solana.com/developing/lookup-tables#how-to-create-an-address-lookup-table" target="_blank" rel="noopener noreferrer">如何使用地址查找表（LUTs）構建版本化事務<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://beta.docs.solana.com/proposals/transactions-v2#limitations" target="_blank" rel="noopener noreferrer">版本化交易的限制<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://beta.docs.solana.com/proposals/transactions-v2#security-concerns" target="_blank" rel="noopener noreferrer">版本化交易的安全性問題<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://beta.docs.solana.com/proposals/transactions-v2#other-proposals" target="_blank" rel="noopener noreferrer">版本化交易的替代性解決方案<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><h2 id="參考資料" tabindex="-1"><a class="header-anchor" href="#參考資料" aria-hidden="true">#</a> 參考資料</h2><ul><li><a href="https://beta.docs.solana.com/proposals/transactions-v2" target="_blank" rel="noopener noreferrer">Transactions-V2 Proposal<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://beta.docs.solana.com/developing/versioned-transactions" target="_blank" rel="noopener noreferrer">使用版本化交易來開發<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: 138085102+lillianrf@users.noreply.github.com">lillianrf</span><!----><!--]--><!--]--></span></div></footer><!----><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.07ce7a66.js" defer></script>
  </body>
</html>
