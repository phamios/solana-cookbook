<!DOCTYPE html>
<html lang="vi-VN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <meta name="generator" content="VuePress 2.0.0-beta.36">
    <style>
      :root {
        --c-bg: #fff;
      }
      html.dark {
        --c-bg: #22272e;
      }
      html, body {
        background-color: var(--c-bg);
      }
    </style>
    <script>
      const userMode = localStorage.getItem('vuepress-color-scheme');
			const systemDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
			if (userMode === 'dark' || (userMode !== 'light' && systemDarkMode)) {
				document.documentElement.classList.toggle('dark', true);
			}
    </script>
    <meta name="title" content="Toàn tập Solana | Nâng cấp dữ liệu cho Program Account"><meta name="og:title" content="Toàn tập Solana | Nâng cấp dữ liệu cho Program Account"><meta name="description" content="Cơ bản về thông tin phiên bản hỗ trở nâng cấp nghĩa là tạo ra những tham chiếu độc lập cho từng tập dữ liệu. Tham chiếu này có thể là một câu truy vấn, một mã định danh, hay thường hơn là ngày tháng. Chi tiết về Nâng cấp dữ liệu cho Program Account và các khái niệm cơn bản khác trong Toàn tập Solana."><meta name="og:description" content="Cơ bản về thông tin phiên bản hỗ trở nâng cấp nghĩa là tạo ra những tham chiếu độc lập cho từng tập dữ liệu. Tham chiếu này có thể là một câu truy vấn, một mã định danh, hay thường hơn là ngày tháng. Chi tiết về Nâng cấp dữ liệu cho Program Account và các khái niệm cơn bản khác trong Toàn tập Solana."><meta name="og:image" content="https://solanacookbook.com/cookbook-sharing-card.png"><meta name="og:image:alt" content="Solana splash card"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@solanacookbook"><meta name="twitter:image" content="https://solanacookbook.com/cookbook-sharing-card.png"><meta name="robots" content="index,follow,noodp"><meta name="googlebot" content="index,follow"><link rel="icon" href="/solana_cookbook_lightmode.svg"><script data-domain="solanacookbook.com" src="https://plausible.io/js/plausible.js"></script><title>Nâng cấp dữ liệu cho Program Account | Toàn tập Solana</title>
    <link rel="modulepreload" href="/assets/app.07ce7a66.js"><link rel="modulepreload" href="/assets/data-migration.html.159d137d.js"><link rel="modulepreload" href="/assets/data-migration.html.a0b30eb8.js">
    <link rel="stylesheet" href="/assets/style.fecd2c41.css">
  </head>
  <body>
    <div id="app"><!--[--><div class="theme-container"><!--[--><header ref_key="navbar" class="navbar"><div class="toggle-sidebar-button" title="toggle sidebar" aria-expanded="false" role="button" tabindex="0"><div class="icon" aria-hidden="true"><span></span><span></span><span></span></div></div><span><a href="/vi/" class=""><!----><span class="site-name can-hide">Toàn tập Solana</span></a></span><div class="navbar-items-wrapper" style=""><!--[--><!--]--><nav class="navbar-items can-hide"><!--[--><div class="navbar-item"><a class="external-link" href="https://github.com/solana-developers/solana-cookbook" rel="noopener noreferrer" target="_blank" aria-label="Đóng góp"><!--[--><!--]--> Đóng góp <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/guides/data-migration.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/zh/guides/data-migration.html" class="" aria-label="中文（简体）"><!--[--><!--]--> 中文（简体） <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/es/guides/data-migration.html" class="" aria-label="Spanish"><!--[--><!--]--> Spanish <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/pt/guides/data-migration.html" class="" aria-label="Português"><!--[--><!--]--> Português <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/de/guides/data-migration.html" class="" aria-label="Deutsch"><!--[--><!--]--> Deutsch <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/vi/guides/data-migration.html" class="router-link-active router-link-exact-active router-link-active" aria-label="Tiếng Việt"><!--[--><!--]--> Tiếng Việt <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/th/guides/data-migration.html" class="" aria-label="ไทย"><!--[--><!--]--> ไทย <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/fr/guides/data-migration.html" class="" aria-label="Français"><!--[--><!--]--> Français <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/id/guides/data-migration.html" class="" aria-label="Bahasa Indonesia"><!--[--><!--]--> Bahasa Indonesia <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/kr/guides/data-migration.html" class="" aria-label="한국어"><!--[--><!--]--> 한국어 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/tr/guides/data-migration.html" class="" aria-label="Türkçe"><!--[--><!--]--> Türkçe <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ja/guides/data-migration.html" class="" aria-label="日本語"><!--[--><!--]--> 日本語 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/fil/guides/data-migration.html" class="" aria-label="Filipino"><!--[--><!--]--> Filipino <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><button class="toggle-dark-button" title="toggle dark mode"><svg style="" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M16 12.005a4 4 0 1 1-4 4a4.005 4.005 0 0 1 4-4m0-2a6 6 0 1 0 6 6a6 6 0 0 0-6-6z" fill="currentColor"></path><path d="M5.394 6.813l1.414-1.415l3.506 3.506L8.9 10.318z" fill="currentColor"></path><path d="M2 15.005h5v2H2z" fill="currentColor"></path><path d="M5.394 25.197L8.9 21.691l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 25.005h2v5h-2z" fill="currentColor"></path><path d="M21.687 23.106l1.414-1.415l3.506 3.506l-1.414 1.414z" fill="currentColor"></path><path d="M25 15.005h5v2h-5z" fill="currentColor"></path><path d="M21.687 8.904l3.506-3.506l1.414 1.415l-3.506 3.505z" fill="currentColor"></path><path d="M15 2.005h2v5h-2z" fill="currentColor"></path></svg><svg style="display:none;" class="icon" focusable="false" viewBox="0 0 32 32"><path d="M13.502 5.414a15.075 15.075 0 0 0 11.594 18.194a11.113 11.113 0 0 1-7.975 3.39c-.138 0-.278.005-.418 0a11.094 11.094 0 0 1-3.2-21.584M14.98 3a1.002 1.002 0 0 0-.175.016a13.096 13.096 0 0 0 1.825 25.981c.164.006.328 0 .49 0a13.072 13.072 0 0 0 10.703-5.555a1.01 1.01 0 0 0-.783-1.565A13.08 13.08 0 0 1 15.89 4.38A1.015 1.015 0 0 0 14.98 3z" fill="currentColor"></path></svg></button><div id="docsearch-container"></div></div></header><!--]--><div class="sidebar-mask"></div><!--[--><aside class="sidebar"><nav class="navbar-items"><!--[--><div class="navbar-item"><a class="external-link" href="https://github.com/solana-developers/solana-cookbook" rel="noopener noreferrer" target="_blank" aria-label="Đóng góp"><!--[--><!--]--> Đóng góp <span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span><!--[--><!--]--></a></div><div class="navbar-item"><div class="navbar-dropdown-wrapper"><button class="navbar-dropdown-title" type="button" aria-label="Select language"><span class="title">Languages</span><span class="arrow down"></span></button><button class="navbar-dropdown-title-mobile" type="button" aria-label="Select language"><span class="title">Languages</span><span class="right arrow"></span></button><!--[--><ul style="display:none;" class="navbar-dropdown"><!--[--><li class="navbar-dropdown-item"><a href="/guides/data-migration.html" class="" aria-label="English"><!--[--><!--]--> English <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/zh/guides/data-migration.html" class="" aria-label="中文（简体）"><!--[--><!--]--> 中文（简体） <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/es/guides/data-migration.html" class="" aria-label="Spanish"><!--[--><!--]--> Spanish <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/pt/guides/data-migration.html" class="" aria-label="Português"><!--[--><!--]--> Português <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/de/guides/data-migration.html" class="" aria-label="Deutsch"><!--[--><!--]--> Deutsch <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a aria-current="page" href="/vi/guides/data-migration.html" class="router-link-active router-link-exact-active router-link-active" aria-label="Tiếng Việt"><!--[--><!--]--> Tiếng Việt <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/th/guides/data-migration.html" class="" aria-label="ไทย"><!--[--><!--]--> ไทย <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/fr/guides/data-migration.html" class="" aria-label="Français"><!--[--><!--]--> Français <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/id/guides/data-migration.html" class="" aria-label="Bahasa Indonesia"><!--[--><!--]--> Bahasa Indonesia <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/kr/guides/data-migration.html" class="" aria-label="한국어"><!--[--><!--]--> 한국어 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/tr/guides/data-migration.html" class="" aria-label="Türkçe"><!--[--><!--]--> Türkçe <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/ja/guides/data-migration.html" class="" aria-label="日本語"><!--[--><!--]--> 日本語 <!--[--><!--]--></a></li><li class="navbar-dropdown-item"><a href="/fil/guides/data-migration.html" class="" aria-label="Filipino"><!--[--><!--]--> Filipino <!--[--><!--]--></a></li><!--]--></ul><!--]--></div></div><!--]--></nav><!--[--><!--]--><ul class="sidebar-items"><!--[--><li><p tabindex="0" class="sidebar-item sidebar-heading">Mở đầu <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/vi/" class="sidebar-item" aria-label="Nhập môn Solana"><!--[--><!--]--> Nhập môn Solana <!--[--><!--]--></a><!----></li><li><a href="/vi/getting-started/installation.html" class="sidebar-item" aria-label="Cài đặt"><!--[--><!--]--> Cài đặt <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">Khái niệm căn bản <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/vi/core-concepts/accounts.html" class="sidebar-item" aria-label="Accounts"><!--[--><!--]--> Accounts <!--[--><!--]--></a><!----></li><li><a href="/vi/core-concepts/programs.html" class="sidebar-item" aria-label="Programs"><!--[--><!--]--> Programs <!--[--><!--]--></a><!----></li><li><a href="/vi/core-concepts/transactions.html" class="sidebar-item" aria-label="Transactions"><!--[--><!--]--> Transactions <!--[--><!--]--></a><!----></li><li><a href="/vi/core-concepts/pdas.html" class="sidebar-item" aria-label="Program Derived Addresses (PDAs)"><!--[--><!--]--> Program Derived Addresses (PDAs) <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading active">Hướng dẫn <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/vi/guides/get-program-accounts.html" class="sidebar-item" aria-label="Đọc dữ liệu Program Account"><!--[--><!--]--> Đọc dữ liệu Program Account <!--[--><!--]--></a><!----></li><li><a href="/vi/guides/serialization.html" class="sidebar-item" aria-label="Tuần tự hoá dữ liệu"><!--[--><!--]--> Tuần tự hoá dữ liệu <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vi/guides/data-migration.html" class="router-link-active router-link-exact-active router-link-active sidebar-item active" aria-label="Nâng cấp dữ liệu cho Program Account"><!--[--><!--]--> Nâng cấp dữ liệu cho Program Account <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/vi/guides/data-migration.html#lam-the-nao-đe-co-the-nang-cap-du-lieu-trong-program-account" class="router-link-active router-link-exact-active sidebar-item" aria-label="Làm thế nào để có thể nâng cấp dữ liệu trong Program Account?"><!--[--><!--]--> Làm thế nào để có thể nâng cấp dữ liệu trong Program Account? <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vi/guides/data-migration.html#ngu-canh" class="router-link-active router-link-exact-active sidebar-item" aria-label="Ngữ cảnh"><!--[--><!--]--> Ngữ cảnh <!--[--><!--]--></a><!----></li><li><a aria-current="page" href="/vi/guides/data-migration.html#nang-cap-account" class="router-link-active router-link-exact-active sidebar-item" aria-label="Nâng cấp Account"><!--[--><!--]--> Nâng cấp Account <!--[--><!--]--></a><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a aria-current="page" href="/vi/guides/data-migration.html#_1-them-luan-ly-đe-chuyen-đoi-account" class="router-link-active router-link-exact-active sidebar-item" aria-label="1. Thêm luận lý để chuyển đổi Account"><!--[--><!--]--> 1. Thêm luận lý để chuyển đổi Account <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a aria-current="page" href="/vi/guides/data-migration.html#cac-nguon-tai-lieu-khac" class="router-link-active router-link-exact-active sidebar-item" aria-label="Các nguồn tài liệu khác"><!--[--><!--]--> Các nguồn tài liệu khác <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><a href="/vi/guides/account-maps.html" class="sidebar-item" aria-label="Account Maps"><!--[--><!--]--> Account Maps <!--[--><!--]--></a><!----></li><li><a href="/vi/guides/debugging-solana-programs.html" class="sidebar-item" aria-label="Soát lỗi chương trình trên Solana"><!--[--><!--]--> Soát lỗi chương trình trên Solana <!--[--><!--]--></a><!----></li><li><a href="/vi/guides/feature-parity-testing.html" class="sidebar-item" aria-label="Đề xuất Kiểm thử Parity"><!--[--><!--]--> Đề xuất Kiểm thử Parity <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><li><p tabindex="0" class="sidebar-item sidebar-heading">Tham khảo <!----></p><!--[--><ul style="" class="sidebar-item-children"><!--[--><li><a href="/vi/references/local-development.html" class="sidebar-item" aria-label="Lập trình ở Local"><!--[--><!--]--> Lập trình ở Local <!--[--><!--]--></a><!----></li><li><a href="/vi/references/keypairs-and-wallets.html" class="sidebar-item" aria-label="Cặp khoá và Ví"><!--[--><!--]--> Cặp khoá và Ví <!--[--><!--]--></a><!----></li><li><a href="/vi/references/basic-transactions.html" class="sidebar-item" aria-label="Gửi Transaction"><!--[--><!--]--> Gửi Transaction <!--[--><!--]--></a><!----></li><li><a href="/vi/references/accounts.html" class="sidebar-item" aria-label="Accounts"><!--[--><!--]--> Accounts <!--[--><!--]--></a><!----></li><li><a href="/vi/references/programs.html" class="sidebar-item" aria-label="Xây dựng Programs"><!--[--><!--]--> Xây dựng Programs <!--[--><!--]--></a><!----></li><li><a href="/vi/references/token.html" class="sidebar-item" aria-label="Tương tác với Tokens"><!--[--><!--]--> Tương tác với Tokens <!--[--><!--]--></a><!----></li><li><a href="/vi/references/staking.html" class="sidebar-item" aria-label="Staking"><!--[--><!--]--> Staking <!--[--><!--]--></a><!----></li><li><a href="/vi/references/nfts.html" class="sidebar-item" aria-label="NFTs"><!--[--><!--]--> NFTs <!--[--><!--]--></a><!----></li><li><a href="/vi/references/offline-transactions.html" class="sidebar-item" aria-label="Gửi Transactions Ngoại tuyến"><!--[--><!--]--> Gửi Transactions Ngoại tuyến <!--[--><!--]--></a><!----></li><li><a href="/vi/references/name-service.html" class="sidebar-item" aria-label="Dịch vụ tên miền"><!--[--><!--]--> Dịch vụ tên miền <!--[--><!--]--></a><!----></li><!--]--></ul><!--]--></li><!--]--></ul><!--[--><!--]--></aside><!--]--><!--[--><main class="page"><!--[--><!--]--><div class="theme-default-content"><!--[--><h1 id="nang-cap-du-lieu-mot-program-account" tabindex="-1"><a class="header-anchor" href="#nang-cap-du-lieu-mot-program-account" aria-hidden="true">#</a> Nâng cấp dữ liệu một Program Account</h1><h2 id="lam-the-nao-đe-co-the-nang-cap-du-lieu-trong-program-account" tabindex="-1"><a class="header-anchor" href="#lam-the-nao-đe-co-the-nang-cap-du-lieu-trong-program-account" aria-hidden="true">#</a> Làm thế nào để có thể nâng cấp dữ liệu trong Program Account?</h2><p>Khi bạn tạo một Program, mỗi Account dữ liệu sẽ được gán cho Program đó với cấu trục dữ liệu cụ thể. Nếu bạn từng nâng cấp Program và Program này dùng để suy ra các PDA, bạn chắc hẳn đã phải đau đầu với hàng tá những Account với cấu trúc gắn với Program cũ.</p><p>Với việc đánh phiên bản cho Account, bạn có thể dễ dàng nâng cấp cấu trúc mới cho các Account cũ .</p><div class="custom-container tip"><p class="custom-container-title">Lưu ý</p><p>Đây chỉ là một trong rất nhiều cách khác nhau để nâng cấp dữ liệu trong Program Owned Accounts (POA).</p></div><h2 id="ngu-canh" tabindex="-1"><a class="header-anchor" href="#ngu-canh" aria-hidden="true">#</a> Ngữ cảnh</h2><p>Để đánh phiên bản và nâng cấp dữ liệu trong Account, chúng ta sẽ phải cung cấp một <strong>id</strong> cho từng Account. Id này sẽ cho phép chúng ta định rõ phiên bản của Account khi truyền nó cho Program, và như vậy có thể xử lý Account một cách chính xác.</p><p>Quan sát trạng thái bên dưới của Account và Program:</p><img src="/assets/pav1.1b0417ca.png" alt="Program Account v1"><div class="code-group"><div class="code-group__nav"><ul class="code-group__ul"><!--[--><li class="code-group__li"><button class="code-group__nav-tab code-group__nav-tab-active" ariapressed="true" ariaexpanded="true">Account</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">Instruction</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">Processor</button></li><!--]--><li class="flex-grow"></li><li class="code-group__li"><button class="code-group__nav-tab"><svg width="18" height="18" viewbox="0 0 24 24" fill="none"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg></button></li><li class="code-group__li"><button class="code-group__nav-tab"><svg width="18" height="18" viewbox="0 0 24 24" fill="none"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg></button></li></ul></div><div><div class="code-info-title">Press &lt;/&gt; button to view full source</div></div><!--[--><div class="code-group-item code-group-item__active" aria-selected="true" data-v-6ae3d40e><div class="" data-v-6ae3d40e><!--[--><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">//! @brief account_state manages account data</span>

<span class="token keyword">use</span> <span class="token namespace">arrayref<span class="token punctuation">::</span></span><span class="token punctuation">{</span>array_ref<span class="token punctuation">,</span> array_refs<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">borsh<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BorshDeserialize</span><span class="token punctuation">,</span> <span class="token class-name">BorshSerialize</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">solana_program<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    msg<span class="token punctuation">,</span>
    <span class="token namespace">program_error<span class="token punctuation">::</span></span><span class="token class-name">ProgramError</span><span class="token punctuation">,</span>
    <span class="token namespace">program_pack<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">IsInitialized</span><span class="token punctuation">,</span> <span class="token class-name">Pack</span><span class="token punctuation">,</span> <span class="token class-name">Sealed</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">BufWriter</span><span class="token punctuation">,</span> mem<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/// Currently using state. If version changes occur, this</span>
<span class="token comment">/// should be copied to another serializable backlevel one</span>
<span class="token comment">/// before adding new fields here</span>
<span class="token attribute attr-name">#[derive(BorshDeserialize, BorshSerialize, Debug, Default, PartialEq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">AccountContentCurrent</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> somevalue<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Maintains account data</span>
<span class="token attribute attr-name">#[derive(BorshDeserialize, BorshSerialize, Debug, Default, PartialEq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
    is_initialized<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    data_version<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    account_data<span class="token punctuation">:</span> <span class="token class-name">AccountContentCurrent</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Signal initialized</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">set_initialized</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>is_initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/// Get the initialized flag</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">initialized</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>is_initialized
    <span class="token punctuation">}</span>
    <span class="token comment">/// Gets the current data version</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">version</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u8</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>data_version
    <span class="token punctuation">}</span>
    <span class="token comment">/// Get the reference to content structure</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">content</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">AccountContentCurrent</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>account_data
    <span class="token punctuation">}</span>
    <span class="token comment">/// Get the mutable reference to content structure</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">content_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">AccountContentCurrent</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>account_data
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Declaration of the current data version.</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">DATA_VERSION</span><span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
<span class="token comment">/// Account allocated size</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">ACCOUNT_ALLOCATION_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token comment">/// Initialized flag is 1st byte of data block</span>
<span class="token keyword">const</span> <span class="token constant">IS_INITIALIZED</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">/// Data version (current) is 2nd byte of data block</span>
<span class="token keyword">const</span> <span class="token constant">DATA_VERSION_ID</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">/// Previous content data size (before changing this is equal to current)</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">PREVIOUS_VERSION_DATA_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">AccountContentCurrent</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/// Total space occupied by previous account data</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">PREVIOUS_ACCOUNT_SPACE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span>
    <span class="token constant">IS_INITIALIZED</span> <span class="token operator">+</span> <span class="token constant">DATA_VERSION_ID</span> <span class="token operator">+</span> <span class="token constant">PREVIOUS_VERSION_DATA_SIZE</span><span class="token punctuation">;</span>

<span class="token comment">/// Current content data size</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">CURRENT_VERSION_DATA_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">AccountContentCurrent</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/// Total usage for data only</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">CURRENT_USED_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token constant">IS_INITIALIZED</span> <span class="token operator">+</span> <span class="token constant">DATA_VERSION_ID</span> <span class="token operator">+</span> <span class="token constant">CURRENT_VERSION_DATA_SIZE</span><span class="token punctuation">;</span>
<span class="token comment">/// How much of 1024 is used</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">CURRENT_UNUSED_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token constant">ACCOUNT_ALLOCATION_SIZE</span> <span class="token operator">-</span> <span class="token constant">CURRENT_USED_SIZE</span><span class="token punctuation">;</span>
<span class="token comment">/// Current space used by header (initialized, data version and Content)</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">ACCOUNT_STATE_SPACE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token constant">CURRENT_USED_SIZE</span> <span class="token operator">+</span> <span class="token constant">CURRENT_UNUSED_SIZE</span><span class="token punctuation">;</span>

<span class="token comment">/// Future data migration logic that converts prior state of data</span>
<span class="token comment">/// to current state of data</span>
<span class="token keyword">fn</span> <span class="token function-definition function">conversion_logic</span><span class="token punctuation">(</span>src<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">ProgramAccountState</span><span class="token punctuation">,</span> <span class="token class-name">ProgramError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> past <span class="token operator">=</span> <span class="token macro property">array_ref!</span><span class="token punctuation">[</span>src<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">PREVIOUS_ACCOUNT_SPACE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>initialized<span class="token punctuation">,</span> _<span class="token punctuation">,</span> _account_space<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token macro property">array_refs!</span><span class="token punctuation">[</span>
        past<span class="token punctuation">,</span>
        <span class="token constant">IS_INITIALIZED</span><span class="token punctuation">,</span>
        <span class="token constant">DATA_VERSION_ID</span><span class="token punctuation">,</span>
        <span class="token constant">PREVIOUS_VERSION_DATA_SIZE</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// Logic to uplift from previous version</span>
    <span class="token comment">// GOES HERE</span>

    <span class="token comment">// Give back</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
        is_initialized<span class="token punctuation">:</span> initialized<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0u8</span><span class="token punctuation">,</span>
        data_version<span class="token punctuation">:</span> <span class="token constant">DATA_VERSION</span><span class="token punctuation">,</span>
        account_data<span class="token punctuation">:</span> <span class="token class-name">AccountContentCurrent</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">Sealed</span> <span class="token keyword">for</span> <span class="token class-name">ProgramAccountState</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">IsInitialized</span> <span class="token keyword">for</span> <span class="token class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">is_initialized</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>is_initialized
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Pack</span> <span class="token keyword">for</span> <span class="token class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token constant">LEN</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token constant">ACCOUNT_STATE_SPACE</span><span class="token punctuation">;</span>

    <span class="token comment">/// Store &#39;state&#39; of account to its data area</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">pack_into_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> dst<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> bw <span class="token operator">=</span> <span class="token class-name">BufWriter</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> bw<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Retrieve &#39;state&#39; of account from account data area</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">unpack_from_slice</span><span class="token punctuation">(</span>src<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token class-name">ProgramError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> initialized <span class="token operator">=</span> src<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// Check initialized</span>
        <span class="token keyword">if</span> initialized <span class="token punctuation">{</span>
            <span class="token comment">// Version check</span>
            <span class="token keyword">if</span> src<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">DATA_VERSION</span> <span class="token punctuation">{</span>
                <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Processing consistent data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span>
                    <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">try_from_slice</span><span class="token punctuation">(</span><span class="token macro property">array_ref!</span><span class="token punctuation">[</span>src<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">CURRENT_USED_SIZE</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
                        <span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Processing backlevel data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">conversion_logic</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Processing pre-initialized data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
                is_initialized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                data_version<span class="token punctuation">:</span> <span class="token constant">DATA_VERSION</span><span class="token punctuation">,</span>
                account_data<span class="token punctuation">:</span> <span class="token class-name">AccountContentCurrent</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br></div></div><!--]--></div><div class="hidden" data-v-6ae3d40e><!--[--><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token attribute attr-name">#[derive(BorshDeserialize, BorshSerialize, Debug, Default, PartialEq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">AccountContentCurrent</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> somevalue<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[derive(BorshDeserialize, BorshSerialize, Debug, Default, PartialEq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
    is_initialized<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    data_version<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    account_data<span class="token punctuation">:</span> <span class="token class-name">AccountContentCurrent</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><!--]--></div></div><div class="code-group-item code-group-item__active" aria-selected="true" data-v-6ae3d40e><div class="" data-v-6ae3d40e><!--[--><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">//! instruction Contains the main ProgramInstruction enum</span>

<span class="token keyword">use</span> <span class="token punctuation">{</span>
    <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>error<span class="token punctuation">::</span></span><span class="token class-name">DataVersionError</span><span class="token punctuation">,</span>
    <span class="token namespace">borsh<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BorshDeserialize</span><span class="token punctuation">,</span> <span class="token class-name">BorshSerialize</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">solana_program<span class="token punctuation">::</span>program_error<span class="token punctuation">::</span></span><span class="token class-name">ProgramError</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(BorshDeserialize, BorshSerialize, Debug, PartialEq)]</span>
<span class="token comment">/// All custom program instructions</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">ProgramInstruction</span> <span class="token punctuation">{</span>
    <span class="token class-name">InitializeAccount</span><span class="token punctuation">,</span>
    <span class="token class-name">SetU64Value</span><span class="token punctuation">(</span><span class="token keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">FailInstruction</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">ProgramInstruction</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Unpack inbound buffer to associated Instruction</span>
    <span class="token comment">/// The expected format for input is a Borsh serialized vector</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">unpack</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token class-name">ProgramError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> payload <span class="token operator">=</span> <span class="token class-name">ProgramInstruction</span><span class="token punctuation">::</span><span class="token function">try_from_slice</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> payload <span class="token punctuation">{</span>
            <span class="token class-name">ProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">InitializeAccount</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">ProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">SetU64Value</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">DataVersionError</span><span class="token punctuation">::</span><span class="token class-name">InvalidInstruction</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br></div></div><!--]--></div><div class="hidden" data-v-6ae3d40e><!--[--><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">impl</span> <span class="token class-name">ProgramInstruction</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Unpack inbound buffer to associated Instruction</span>
    <span class="token comment">/// The expected format for input is a Borsh serialized vector</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">unpack</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token class-name">ProgramError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> payload <span class="token operator">=</span> <span class="token class-name">ProgramInstruction</span><span class="token punctuation">::</span><span class="token function">try_from_slice</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">match</span> payload <span class="token punctuation">{</span>
            <span class="token class-name">ProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">InitializeAccount</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">ProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">SetU64Value</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
            _ <span class="token operator">=&gt;</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">DataVersionError</span><span class="token punctuation">::</span><span class="token class-name">InvalidInstruction</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><!--]--></div></div><div class="code-group-item code-group-item__active" aria-selected="true" data-v-6ae3d40e><div class="" data-v-6ae3d40e><!--[--><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">//! Resolve instruction and execute</span>

<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token punctuation">{</span>
    <span class="token namespace">account_state<span class="token punctuation">::</span></span><span class="token class-name">ProgramAccountState</span><span class="token punctuation">,</span> <span class="token namespace">error<span class="token punctuation">::</span></span><span class="token class-name">DataVersionError</span><span class="token punctuation">,</span> <span class="token namespace">instruction<span class="token punctuation">::</span></span><span class="token class-name">ProgramInstruction</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">solana_program<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">account_info<span class="token punctuation">::</span></span><span class="token punctuation">{</span>next_account_info<span class="token punctuation">,</span> <span class="token class-name">AccountInfo</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">entrypoint<span class="token punctuation">::</span></span><span class="token class-name">ProgramResult</span><span class="token punctuation">,</span>
    msg<span class="token punctuation">,</span>
    <span class="token namespace">program_error<span class="token punctuation">::</span></span><span class="token class-name">ProgramError</span><span class="token punctuation">,</span>
    <span class="token namespace">program_pack<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">IsInitialized</span><span class="token punctuation">,</span> <span class="token class-name">Pack</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">pubkey<span class="token punctuation">::</span></span><span class="token class-name">Pubkey</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/// Checks each tracking account to confirm it is owned by our program</span>
<span class="token comment">/// This function assumes that the program account is always the last</span>
<span class="token comment">/// in the array</span>
<span class="token keyword">fn</span> <span class="token function-definition function">check_account_ownership</span><span class="token punctuation">(</span>program_id<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Pubkey</span><span class="token punctuation">,</span> accounts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">AccountInfo</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProgramResult</span> <span class="token punctuation">{</span>
    <span class="token comment">// Accounts must be owned by the program.</span>
    <span class="token keyword">for</span> account <span class="token keyword">in</span> accounts<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>accounts<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> account<span class="token punctuation">.</span>owner <span class="token operator">!=</span> program_id <span class="token punctuation">{</span>
            <span class="token macro property">msg!</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Fail: The tracking account owner is {} and it should be {}.&quot;</span><span class="token punctuation">,</span>
                account<span class="token punctuation">.</span>owner<span class="token punctuation">,</span>
                program_id
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ProgramError</span><span class="token punctuation">::</span><span class="token class-name">IncorrectProgramId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Initialize the programs account, which is the first in accounts</span>
<span class="token keyword">fn</span> <span class="token function-definition function">initialize_account</span><span class="token punctuation">(</span>accounts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">AccountInfo</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProgramResult</span> <span class="token punctuation">{</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Initialize account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> account_info_iter <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> accounts<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> program_account <span class="token operator">=</span> <span class="token function">next_account_info</span><span class="token punctuation">(</span>account_info_iter<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_data <span class="token operator">=</span> program_account<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Just using unpack will check to see if initialized and will</span>
    <span class="token comment">// fail if not</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_state <span class="token operator">=</span> <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">unpack_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>account_data<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token comment">// Where this is a logic error in trying to initialize the same account more than once</span>
    <span class="token keyword">if</span> account_state<span class="token punctuation">.</span><span class="token function">is_initialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">DataVersionError</span><span class="token punctuation">::</span><span class="token class-name">AlreadyInitializedState</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        account_state<span class="token punctuation">.</span><span class="token function">set_initialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        account_state<span class="token punctuation">.</span><span class="token function">content_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>somevalue <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Account Initialized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Serialize</span>
    <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">pack</span><span class="token punctuation">(</span>account_state<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> account_data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Sets the u64 in the content structure</span>
<span class="token keyword">fn</span> <span class="token function-definition function">set_u64_value</span><span class="token punctuation">(</span>accounts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">AccountInfo</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProgramResult</span> <span class="token punctuation">{</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Set new value {}&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> account_info_iter <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> accounts<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> program_account <span class="token operator">=</span> <span class="token function">next_account_info</span><span class="token punctuation">(</span>account_info_iter<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_data <span class="token operator">=</span> program_account<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_state <span class="token operator">=</span> <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>account_data<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    account_state<span class="token punctuation">.</span><span class="token function">content_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>somevalue <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token comment">// Serialize</span>
    <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">pack</span><span class="token punctuation">(</span>account_state<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> account_data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">/// Main processing entry point dispatches to specific</span>
<span class="token comment">/// instruction handlers</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span>
    program_id<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Pubkey</span><span class="token punctuation">,</span>
    accounts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">AccountInfo</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    instruction_data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProgramResult</span> <span class="token punctuation">{</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Received process request&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Check the account for program relationship</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">check_account_ownership</span><span class="token punctuation">(</span>program_id<span class="token punctuation">,</span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// Unpack the inbound data, mapping instruction to appropriate structure</span>
    <span class="token keyword">let</span> instruction <span class="token operator">=</span> <span class="token class-name">ProgramInstruction</span><span class="token punctuation">::</span><span class="token function">unpack</span><span class="token punctuation">(</span>instruction_data<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> instruction <span class="token punctuation">{</span>
        <span class="token class-name">ProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">InitializeAccount</span> <span class="token operator">=&gt;</span> <span class="token function">initialize_account</span><span class="token punctuation">(</span>accounts<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">ProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">SetU64Value</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">set_u64_value</span><span class="token punctuation">(</span>accounts<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Received unknown instruction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">DataVersionError</span><span class="token punctuation">::</span><span class="token class-name">InvalidInstruction</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br></div></div><!--]--></div><div class="hidden" data-v-6ae3d40e><!--[--><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token keyword">fn</span> <span class="token function-definition function">check_account_ownership</span><span class="token punctuation">(</span>program_id<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Pubkey</span><span class="token punctuation">,</span> accounts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">AccountInfo</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProgramResult</span> <span class="token punctuation">{</span>
    <span class="token comment">// Accounts must be owned by the program.</span>
    <span class="token keyword">for</span> account <span class="token keyword">in</span> accounts<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>accounts<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> account<span class="token punctuation">.</span>owner <span class="token operator">!=</span> program_id <span class="token punctuation">{</span>
            <span class="token macro property">msg!</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Fail: The tracking account owner is {} and it should be {}.&quot;</span><span class="token punctuation">,</span>
                account<span class="token punctuation">.</span>owner<span class="token punctuation">,</span>
                program_id
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ProgramError</span><span class="token punctuation">::</span><span class="token class-name">IncorrectProgramId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Initialize the programs account, which is the first in accounts</span>
<span class="token keyword">fn</span> <span class="token function-definition function">initialize_account</span><span class="token punctuation">(</span>accounts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">AccountInfo</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProgramResult</span> <span class="token punctuation">{</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Initialize account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> account_info_iter <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> accounts<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> program_account <span class="token operator">=</span> <span class="token function">next_account_info</span><span class="token punctuation">(</span>account_info_iter<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_data <span class="token operator">=</span> program_account<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Just using unpack will check to see if initialized and will</span>
    <span class="token comment">// fail if not</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_state <span class="token operator">=</span> <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">unpack_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>account_data<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token comment">// Where this is a logic error in trying to initialize the same account more than once</span>
    <span class="token keyword">if</span> account_state<span class="token punctuation">.</span><span class="token function">is_initialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">DataVersionError</span><span class="token punctuation">::</span><span class="token class-name">AlreadyInitializedState</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        account_state<span class="token punctuation">.</span><span class="token function">set_initialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        account_state<span class="token punctuation">.</span><span class="token function">content_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>somevalue <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Account Initialized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Serialize</span>
    <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">pack</span><span class="token punctuation">(</span>account_state<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> account_data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Sets the u64 in the content structure</span>
<span class="token keyword">fn</span> <span class="token function-definition function">set_u64_value</span><span class="token punctuation">(</span>accounts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">AccountInfo</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProgramResult</span> <span class="token punctuation">{</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Set new value {}&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> account_info_iter <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> accounts<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> program_account <span class="token operator">=</span> <span class="token function">next_account_info</span><span class="token punctuation">(</span>account_info_iter<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_data <span class="token operator">=</span> program_account<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_state <span class="token operator">=</span> <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>account_data<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    account_state<span class="token punctuation">.</span><span class="token function">content_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>somevalue <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token comment">// Serialize</span>
    <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">pack</span><span class="token punctuation">(</span>account_state<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> account_data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">/// Main processing entry point dispatches to specific</span>
<span class="token comment">/// instruction handlers</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span>
    program_id<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Pubkey</span><span class="token punctuation">,</span>
    accounts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">AccountInfo</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    instruction_data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProgramResult</span> <span class="token punctuation">{</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Received process request&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Check the account for program relationship</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">check_account_ownership</span><span class="token punctuation">(</span>program_id<span class="token punctuation">,</span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// Unpack the inbound data, mapping instruction to appropriate structure</span>
    <span class="token keyword">let</span> instruction <span class="token operator">=</span> <span class="token class-name">ProgramInstruction</span><span class="token punctuation">::</span><span class="token function">unpack</span><span class="token punctuation">(</span>instruction_data<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> instruction <span class="token punctuation">{</span>
        <span class="token class-name">ProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">InitializeAccount</span> <span class="token operator">=&gt;</span> <span class="token function">initialize_account</span><span class="token punctuation">(</span>accounts<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">ProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">SetU64Value</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">set_u64_value</span><span class="token punctuation">(</span>accounts<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Received unknown instruction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">DataVersionError</span><span class="token punctuation">::</span><span class="token class-name">InvalidInstruction</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br></div></div><!--]--></div></div><!--]--></div><p>Trong phiên bản đầu tiên của Account, chúng ta thực hiện các bước sau:</p><table><thead><tr><th>#</th><th>Mô tả</th></tr></thead><tbody><tr><td>1</td><td>Thêm trường <code>data_version</code> vào dữ liệu. Nó có thể đơn giản là số thứ tự (<code>u8</code>) hoặc có thể phức tạp hơn thế.</td></tr><tr><td>2</td><td>Phân phát một vùng nhớ đủ để chứa dữ liệu</td></tr><tr><td>3</td><td>Khởi tạo một hằng số biễu diễn phiên bản cho các Program khác nhau</td></tr><tr><td>4</td><td>Thêm một hàm cập nhật Account với tên <code>fn conversion_logic</code> cho các nâng cấp trong tương lai</td></tr></tbody></table><p>Giả sử, chúng ta muốn nâng cấp các Account của Program bằng cách thêm một trường mới với tên <code>somestring</code>.</p><p>Nếu chúng ta không phân phát đủ vùng nhớ cho trường mới thêm cho các Account trước đó, quá trình nâng cấp Account sẽ bị mắc kẹt.</p><h2 id="nang-cap-account" tabindex="-1"><a class="header-anchor" href="#nang-cap-account" aria-hidden="true">#</a> Nâng cấp Account</h2><p>Trong Program mới, chúng ta muốn thêm một thuộc tính mới cho nội dung của Account. Những thay đổi bên dưới trình bày cách chúng ta tận dụng cơ cấu Program ban đầu cho phiên bản hiện tại.</p><h3 id="_1-them-luan-ly-đe-chuyen-đoi-account" tabindex="-1"><a class="header-anchor" href="#_1-them-luan-ly-đe-chuyen-đoi-account" aria-hidden="true">#</a> 1. Thêm luận lý để chuyển đổi Account</h3><div class="code-group"><div class="code-group__nav"><ul class="code-group__ul"><!--[--><li class="code-group__li"><button class="code-group__nav-tab code-group__nav-tab-active" ariapressed="true" ariaexpanded="true">Account</button></li><!--]--><li class="flex-grow"></li><li class="code-group__li"><button class="code-group__nav-tab"><svg width="18" height="18" viewbox="0 0 24 24" fill="none"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 20l4-16m4 4l4 4-4 4M6 16l-4-4 4-4"></path></svg></button></li><li class="code-group__li"><button class="code-group__nav-tab"><svg width="18" height="18" viewbox="0 0 24 24" fill="none"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg></button></li></ul></div><div><div class="code-info-title">Press &lt;/&gt; button to view full source</div></div><!--[--><div class="code-group-item" aria-selected="false" data-v-6ae3d40e><div class="" data-v-6ae3d40e><!--[--><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">//! @brief account_state manages account data</span>

<span class="token keyword">use</span> <span class="token namespace">arrayref<span class="token punctuation">::</span></span><span class="token punctuation">{</span>array_ref<span class="token punctuation">,</span> array_refs<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">borsh<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BorshDeserialize</span><span class="token punctuation">,</span> <span class="token class-name">BorshSerialize</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">solana_program<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">borsh<span class="token punctuation">::</span></span>try_from_slice_unchecked<span class="token punctuation">,</span>
    msg<span class="token punctuation">,</span>
    <span class="token namespace">program_error<span class="token punctuation">::</span></span><span class="token class-name">ProgramError</span><span class="token punctuation">,</span>
    <span class="token namespace">program_pack<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">IsInitialized</span><span class="token punctuation">,</span> <span class="token class-name">Pack</span><span class="token punctuation">,</span> <span class="token class-name">Sealed</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">std<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">io<span class="token punctuation">::</span></span><span class="token class-name">BufWriter</span><span class="token punctuation">,</span> mem<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/// Current state (DATA_VERSION 1). If version changes occur, this</span>
<span class="token comment">/// should be copied to another (see AccountContentOld below)</span>
<span class="token comment">/// We&#39;ve added a new field: &#39;somestring&#39;</span>
<span class="token attribute attr-name">#[derive(BorshDeserialize, BorshSerialize, Debug, Default, PartialEq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">AccountContentCurrent</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> somevalue<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> somestring<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Old content state (DATA_VERSION 0).</span>
<span class="token attribute attr-name">#[derive(BorshDeserialize, BorshSerialize, Debug, Default, PartialEq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">AccountContentOld</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> somevalue<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Maintains account data</span>
<span class="token attribute attr-name">#[derive(BorshDeserialize, BorshSerialize, Debug, Default, PartialEq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
    is_initialized<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    data_version<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    account_data<span class="token punctuation">:</span> <span class="token class-name">AccountContentCurrent</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Signal initialized</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">set_initialized</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>is_initialized <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/// Get the initialized flag</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">initialized</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>is_initialized
    <span class="token punctuation">}</span>
    <span class="token comment">/// Gets the current data version</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">version</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">u8</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>data_version
    <span class="token punctuation">}</span>
    <span class="token comment">/// Get the reference to content structure</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">content</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token class-name">AccountContentCurrent</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">.</span>account_data
    <span class="token punctuation">}</span>
    <span class="token comment">/// Get the mutable reference to content structure</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">content_mut</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token class-name">AccountContentCurrent</span> <span class="token punctuation">{</span>
        <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token keyword">self</span><span class="token punctuation">.</span>account_data
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Declaration of the current data version.</span>
<span class="token keyword">const</span> <span class="token constant">DATA_VERSION</span><span class="token punctuation">:</span> <span class="token keyword">u8</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> <span class="token comment">// Adding string to content</span>
                            <span class="token comment">// Previous const DATA_VERSION: u8 = 0;</span>

<span class="token comment">/// Account allocated size</span>
<span class="token keyword">const</span> <span class="token constant">ACCOUNT_ALLOCATION_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">1024</span><span class="token punctuation">;</span>
<span class="token comment">/// Initialized flag is 1st byte of data block</span>
<span class="token keyword">const</span> <span class="token constant">IS_INITIALIZED</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token comment">/// Data version (current) is 2nd byte of data block</span>
<span class="token keyword">const</span> <span class="token constant">DATA_VERSION_ID</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>

<span class="token comment">/// Previous content data size (before changing this is equal to current)</span>
<span class="token keyword">const</span> <span class="token constant">PREVIOUS_VERSION_DATA_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">AccountContentOld</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/// Total space occupied by previous account data</span>
<span class="token keyword">const</span> <span class="token constant">PREVIOUS_ACCOUNT_SPACE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token constant">IS_INITIALIZED</span> <span class="token operator">+</span> <span class="token constant">DATA_VERSION_ID</span> <span class="token operator">+</span> <span class="token constant">PREVIOUS_VERSION_DATA_SIZE</span><span class="token punctuation">;</span>

<span class="token comment">/// Current content data size</span>
<span class="token keyword">const</span> <span class="token constant">CURRENT_VERSION_DATA_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token namespace">mem<span class="token punctuation">::</span></span><span class="token function">size_of</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">AccountContentCurrent</span><span class="token operator">&gt;</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">/// Total usage for data only</span>
<span class="token keyword">const</span> <span class="token constant">CURRENT_USED_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token constant">IS_INITIALIZED</span> <span class="token operator">+</span> <span class="token constant">DATA_VERSION_ID</span> <span class="token operator">+</span> <span class="token constant">CURRENT_VERSION_DATA_SIZE</span><span class="token punctuation">;</span>
<span class="token comment">/// How much of 1024 is used</span>
<span class="token keyword">const</span> <span class="token constant">CURRENT_UNUSED_SIZE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token constant">ACCOUNT_ALLOCATION_SIZE</span> <span class="token operator">-</span> <span class="token constant">CURRENT_USED_SIZE</span><span class="token punctuation">;</span>
<span class="token comment">/// Current space used by header (initialized, data version and Content)</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">ACCOUNT_STATE_SPACE</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token constant">CURRENT_USED_SIZE</span> <span class="token operator">+</span> <span class="token constant">CURRENT_UNUSED_SIZE</span><span class="token punctuation">;</span>

<span class="token comment">/// Future data migration logic that converts prior state of data</span>
<span class="token comment">/// to current state of data</span>
<span class="token keyword">fn</span> <span class="token function-definition function">conversion_logic</span><span class="token punctuation">(</span>src<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">ProgramAccountState</span><span class="token punctuation">,</span> <span class="token class-name">ProgramError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> past <span class="token operator">=</span> <span class="token macro property">array_ref!</span><span class="token punctuation">[</span>src<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token constant">PREVIOUS_ACCOUNT_SPACE</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>initialized<span class="token punctuation">,</span> _<span class="token punctuation">,</span> account_space<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token macro property">array_refs!</span><span class="token punctuation">[</span>
        past<span class="token punctuation">,</span>
        <span class="token constant">IS_INITIALIZED</span><span class="token punctuation">,</span>
        <span class="token constant">DATA_VERSION_ID</span><span class="token punctuation">,</span>
        <span class="token constant">PREVIOUS_VERSION_DATA_SIZE</span>
    <span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token comment">// Logic to upgrade from previous version</span>
    <span class="token comment">// GOES HERE</span>
    <span class="token keyword">let</span> old <span class="token operator">=</span> <span class="token function">try_from_slice_unchecked</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">AccountContentOld</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>account_space<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Default sets &#39;somevalue&#39; to 0 and somestring to default &quot;&quot;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> new_content <span class="token operator">=</span> <span class="token class-name">AccountContentCurrent</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// We copy the existing &#39;somevalue&#39;, the program instructions will read/update &#39;somestring&#39; without fail</span>
    new_content<span class="token punctuation">.</span>somevalue <span class="token operator">=</span> old<span class="token punctuation">.</span>somevalue<span class="token punctuation">;</span>

    <span class="token comment">// Give back</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
        is_initialized<span class="token punctuation">:</span> initialized<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0u8</span><span class="token punctuation">,</span>
        data_version<span class="token punctuation">:</span> <span class="token constant">DATA_VERSION</span><span class="token punctuation">,</span>
        account_data<span class="token punctuation">:</span> new_content<span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token keyword">impl</span> <span class="token class-name">Sealed</span> <span class="token keyword">for</span> <span class="token class-name">ProgramAccountState</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">IsInitialized</span> <span class="token keyword">for</span> <span class="token class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">is_initialized</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token keyword">bool</span> <span class="token punctuation">{</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span>is_initialized
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">Pack</span> <span class="token keyword">for</span> <span class="token class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token constant">LEN</span><span class="token punctuation">:</span> <span class="token keyword">usize</span> <span class="token operator">=</span> <span class="token constant">ACCOUNT_STATE_SPACE</span><span class="token punctuation">;</span>

    <span class="token comment">/// Store &#39;state&#39; of account to its data area</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">pack_into_slice</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">self</span><span class="token punctuation">,</span> dst<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> <span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token keyword">mut</span> bw <span class="token operator">=</span> <span class="token class-name">BufWriter</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>dst<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">self</span><span class="token punctuation">.</span><span class="token function">serialize</span><span class="token punctuation">(</span><span class="token operator">&amp;</span><span class="token keyword">mut</span> bw<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/// Retrieve &#39;state&#39; of account from account data area</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">unpack_from_slice</span><span class="token punctuation">(</span>src<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token class-name">ProgramError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> initialized <span class="token operator">=</span> src<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">// Check initialized</span>
        <span class="token keyword">if</span> initialized <span class="token punctuation">{</span>
            <span class="token comment">// Version check</span>
            <span class="token keyword">if</span> src<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token constant">DATA_VERSION</span> <span class="token punctuation">{</span>
                <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Processing consistent version data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token function">try_from_slice_unchecked</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">ProgramAccountState</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Processing backlevel data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token function">conversion_logic</span><span class="token punctuation">(</span>src<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Processing pre-initialized data&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
                is_initialized<span class="token punctuation">:</span> <span class="token boolean">false</span><span class="token punctuation">,</span>
                data_version<span class="token punctuation">:</span> <span class="token constant">DATA_VERSION</span><span class="token punctuation">,</span>
                account_data<span class="token punctuation">:</span> <span class="token class-name">AccountContentCurrent</span><span class="token punctuation">::</span><span class="token function">default</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br></div></div><!--]--></div><div class="hidden" data-v-6ae3d40e><!--[--><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">/// Current state (DATA_VERSION 1). If version changes occur, this</span>
<span class="token comment">/// should be copied to another (see AccountContentOld below)</span>
<span class="token comment">/// We&#39;ve added a new field: &#39;somestring&#39;</span>
<span class="token attribute attr-name">#[derive(BorshDeserialize, BorshSerialize, Debug, Default, PartialEq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">AccountContentCurrent</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> somevalue<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
    <span class="token keyword">pub</span> somestring<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Old content state (DATA_VERSION 0).</span>
<span class="token attribute attr-name">#[derive(BorshDeserialize, BorshSerialize, Debug, Default, PartialEq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">AccountContentOld</span> <span class="token punctuation">{</span>
    <span class="token keyword">pub</span> somevalue<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Maintains account data</span>
<span class="token attribute attr-name">#[derive(BorshDeserialize, BorshSerialize, Debug, Default, PartialEq)]</span>
<span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">ProgramAccountState</span> <span class="token punctuation">{</span>
    is_initialized<span class="token punctuation">:</span> <span class="token keyword">bool</span><span class="token punctuation">,</span>
    data_version<span class="token punctuation">:</span> <span class="token keyword">u8</span><span class="token punctuation">,</span>
    account_data<span class="token punctuation">:</span> <span class="token class-name">AccountContentCurrent</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br></div></div><!--]--></div></div><!--]--></div><table><thead><tr><th>Dòng</th><th>Mô tả</th></tr></thead><tbody><tr><td>6</td><td>Chúng ta đã thêm <code>solana_program::borsh::try_from_slice_unchecked</code> của Solana để đơn giản hoá việc đọc các tập dữ liệu con từ khối dữ liệu cha</td></tr><tr><td>13-26</td><td>Ở đây, chúng ta phải giữ lại phiên bản cũ, <code>AccountContentOld</code> tại dòng 24, trước khi mở rộng nó thành <code>AccountContentCurrent</code> tại dòng 17.</td></tr><tr><td>60</td><td>Nâng cấp lại hằng số <code>DATA_VERSION</code></td></tr><tr><td>71</td><td>Chúng ta giờ đã có một phiên bản cũ, đồng thời lưu lại kích thước của nó</td></tr><tr><td>86</td><td>Cuối cùng là thêm logic cho quá trình nâng cấp phiên bản dữ liệu cũ thành phiên bản hiện hành</td></tr></tbody></table><p>Sau đó chúng ta cập nhật hàm mới để thêm vào trường <code>somestring</code> và khai báo luận lý của chỉ thị mới trong <code>processor</code>. Lưu ý việc nâng cấp cấu trúc dữ liệu đã được đóng gói trong <code>pack/unpack</code>.</p><div class="code-group"><div class="code-group__nav"><ul class="code-group__ul"><li class="code-group__li"><button class="code-group__nav-tab code-group__nav-tab-active" ariapressed="true" ariaexpanded="true">Instruction</button></li><li class="code-group__li"><button class="code-group__nav-tab" ariapressed="false" ariaexpanded="false">Processor</button></li></ul></div><!--[--><div class="code-group-item" aria-selected="false"><!--[--><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">//! instruction Contains the main VersionProgramInstruction enum</span>

<span class="token keyword">use</span> <span class="token punctuation">{</span>
    <span class="token keyword">crate</span><span class="token module-declaration namespace"><span class="token punctuation">::</span>error<span class="token punctuation">::</span></span><span class="token class-name">DataVersionError</span><span class="token punctuation">,</span>
    <span class="token namespace">borsh<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">BorshDeserialize</span><span class="token punctuation">,</span> <span class="token class-name">BorshSerialize</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">solana_program<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token namespace">borsh<span class="token punctuation">::</span></span>try_from_slice_unchecked<span class="token punctuation">,</span> msg<span class="token punctuation">,</span> <span class="token namespace">program_error<span class="token punctuation">::</span></span><span class="token class-name">ProgramError</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token attribute attr-name">#[derive(BorshDeserialize, BorshSerialize, Debug, PartialEq)]</span>
<span class="token comment">/// All custom program instructions</span>
<span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">VersionProgramInstruction</span> <span class="token punctuation">{</span>
    <span class="token class-name">InitializeAccount</span><span class="token punctuation">,</span>
    <span class="token class-name">SetU64Value</span><span class="token punctuation">(</span><span class="token keyword">u64</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token class-name">SetString</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Added with data version change</span>
    <span class="token class-name">FailInstruction</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span> <span class="token class-name">VersionProgramInstruction</span> <span class="token punctuation">{</span>
    <span class="token comment">/// Unpack inbound buffer to associated Instruction</span>
    <span class="token comment">/// The expected format for input is a Borsh serialized vector</span>
    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">unpack</span><span class="token punctuation">(</span>input<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token class-name">ProgramError</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> payload <span class="token operator">=</span> <span class="token function">try_from_slice_unchecked</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">VersionProgramInstruction</span><span class="token operator">&gt;</span><span class="token punctuation">(</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// let payload = VersionProgramInstruction::try_from_slice(input).unwrap();</span>
        <span class="token keyword">match</span> payload <span class="token punctuation">{</span>
            <span class="token class-name">VersionProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">InitializeAccount</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">VersionProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">SetU64Value</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token class-name">VersionProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">SetString</span><span class="token punctuation">(</span>_<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token class-name">Ok</span><span class="token punctuation">(</span>payload<span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token comment">// Added with data version change</span>
            _ <span class="token operator">=&gt;</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">DataVersionError</span><span class="token punctuation">::</span><span class="token class-name">InvalidInstruction</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br></div></div><!--]--></div><div class="code-group-item" aria-selected="false"><!--[--><div class="language-rust ext-rs line-numbers-mode"><pre class="language-rust"><code><span class="token comment">//! Resolve instruction and execute</span>

<span class="token keyword">use</span> <span class="token keyword">crate</span><span class="token punctuation">::</span><span class="token punctuation">{</span>
    <span class="token namespace">account_state<span class="token punctuation">::</span></span><span class="token class-name">ProgramAccountState</span><span class="token punctuation">,</span> <span class="token namespace">error<span class="token punctuation">::</span></span><span class="token class-name">DataVersionError</span><span class="token punctuation">,</span>
    <span class="token namespace">instruction<span class="token punctuation">::</span></span><span class="token class-name">VersionProgramInstruction</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">solana_program<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token namespace">account_info<span class="token punctuation">::</span></span><span class="token punctuation">{</span>next_account_info<span class="token punctuation">,</span> <span class="token class-name">AccountInfo</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">entrypoint<span class="token punctuation">::</span></span><span class="token class-name">ProgramResult</span><span class="token punctuation">,</span>
    msg<span class="token punctuation">,</span>
    <span class="token namespace">program_error<span class="token punctuation">::</span></span><span class="token class-name">ProgramError</span><span class="token punctuation">,</span>
    <span class="token namespace">program_pack<span class="token punctuation">::</span></span><span class="token punctuation">{</span><span class="token class-name">IsInitialized</span><span class="token punctuation">,</span> <span class="token class-name">Pack</span><span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token namespace">pubkey<span class="token punctuation">::</span></span><span class="token class-name">Pubkey</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">/// Checks each tracking account to confirm it is owned by our program</span>
<span class="token comment">/// This function assumes that the program account is always the last</span>
<span class="token comment">/// in the array</span>
<span class="token keyword">fn</span> <span class="token function-definition function">check_account_ownership</span><span class="token punctuation">(</span>program_id<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Pubkey</span><span class="token punctuation">,</span> accounts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">AccountInfo</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProgramResult</span> <span class="token punctuation">{</span>
    <span class="token comment">// Accounts must be owned by the program.</span>
    <span class="token keyword">for</span> account <span class="token keyword">in</span> accounts<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">take</span><span class="token punctuation">(</span>accounts<span class="token punctuation">.</span><span class="token function">len</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> account<span class="token punctuation">.</span>owner <span class="token operator">!=</span> program_id <span class="token punctuation">{</span>
            <span class="token macro property">msg!</span><span class="token punctuation">(</span>
                <span class="token string">&quot;Fail: The tracking account owner is {} and it should be {}.&quot;</span><span class="token punctuation">,</span>
                account<span class="token punctuation">.</span>owner<span class="token punctuation">,</span>
                program_id
            <span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">ProgramError</span><span class="token punctuation">::</span><span class="token class-name">IncorrectProgramId</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Initialize the programs account, which is the first in accounts</span>
<span class="token keyword">fn</span> <span class="token function-definition function">initialize_account</span><span class="token punctuation">(</span>accounts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">AccountInfo</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProgramResult</span> <span class="token punctuation">{</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Initialize account&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> account_info_iter <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> accounts<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> program_account <span class="token operator">=</span> <span class="token function">next_account_info</span><span class="token punctuation">(</span>account_info_iter<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_data <span class="token operator">=</span> program_account<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Just using unpack will check to see if initialized and will</span>
    <span class="token comment">// fail if not</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_state <span class="token operator">=</span> <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">unpack_unchecked</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>account_data<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token comment">// Where this is a logic error in trying to initialize the same account more than once</span>
    <span class="token keyword">if</span> account_state<span class="token punctuation">.</span><span class="token function">is_initialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">DataVersionError</span><span class="token punctuation">::</span><span class="token class-name">AlreadyInitializedState</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        account_state<span class="token punctuation">.</span><span class="token function">set_initialized</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        account_state<span class="token punctuation">.</span><span class="token function">content_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>somevalue <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Account Initialized&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Serialize</span>
    <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">pack</span><span class="token punctuation">(</span>account_state<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> account_data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Sets the u64 in the content structure</span>
<span class="token keyword">fn</span> <span class="token function-definition function">set_u64_value</span><span class="token punctuation">(</span>accounts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">AccountInfo</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token keyword">u64</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProgramResult</span> <span class="token punctuation">{</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Set new value {}&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> account_info_iter <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> accounts<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> program_account <span class="token operator">=</span> <span class="token function">next_account_info</span><span class="token punctuation">(</span>account_info_iter<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_data <span class="token operator">=</span> program_account<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_state <span class="token operator">=</span> <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>account_data<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    account_state<span class="token punctuation">.</span><span class="token function">content_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>somevalue <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token comment">// Serialize</span>
    <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">pack</span><span class="token punctuation">(</span>account_state<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> account_data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>

<span class="token comment">/// Sets the string in the content structure</span>
<span class="token keyword">fn</span> <span class="token function-definition function">set_string_value</span><span class="token punctuation">(</span>accounts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">AccountInfo</span><span class="token punctuation">]</span><span class="token punctuation">,</span> value<span class="token punctuation">:</span> <span class="token class-name">String</span><span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProgramResult</span> <span class="token punctuation">{</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Set new string {}&quot;</span><span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> account_info_iter <span class="token operator">=</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> accounts<span class="token punctuation">.</span><span class="token function">iter</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> program_account <span class="token operator">=</span> <span class="token function">next_account_info</span><span class="token punctuation">(</span>account_info_iter<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_data <span class="token operator">=</span> program_account<span class="token punctuation">.</span>data<span class="token punctuation">.</span><span class="token function">borrow_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token keyword">mut</span> account_state <span class="token operator">=</span> <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">unpack</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>account_data<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    account_state<span class="token punctuation">.</span><span class="token function">content_mut</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>somestring <span class="token operator">=</span> value<span class="token punctuation">;</span>
    <span class="token comment">// Serialize</span>
    <span class="token class-name">ProgramAccountState</span><span class="token punctuation">::</span><span class="token function">pack</span><span class="token punctuation">(</span>account_state<span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token keyword">mut</span> account_data<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token comment">/// Main processing entry point dispatches to specific</span>
<span class="token comment">/// instruction handlers</span>
<span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">process</span><span class="token punctuation">(</span>
    program_id<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token class-name">Pubkey</span><span class="token punctuation">,</span>
    accounts<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token class-name">AccountInfo</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    instruction_data<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token punctuation">[</span><span class="token keyword">u8</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">)</span> <span class="token punctuation">-&gt;</span> <span class="token class-name">ProgramResult</span> <span class="token punctuation">{</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Received process request 0.2.0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Check the account for program relationship</span>
    <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">check_account_ownership</span><span class="token punctuation">(</span>program_id<span class="token punctuation">,</span> accounts<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span>error<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token comment">// Unpack the inbound data, mapping instruction to appropriate structure</span>
    <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Attempting to unpack&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> instruction <span class="token operator">=</span> <span class="token class-name">VersionProgramInstruction</span><span class="token punctuation">::</span><span class="token function">unpack</span><span class="token punctuation">(</span>instruction_data<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">match</span> instruction <span class="token punctuation">{</span>
        <span class="token class-name">VersionProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">InitializeAccount</span> <span class="token operator">=&gt;</span> <span class="token function">initialize_account</span><span class="token punctuation">(</span>accounts<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">VersionProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">SetU64Value</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">set_u64_value</span><span class="token punctuation">(</span>accounts<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">VersionProgramInstruction</span><span class="token punctuation">::</span><span class="token class-name">SetString</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token function">set_string_value</span><span class="token punctuation">(</span>accounts<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span>
        _ <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token macro property">msg!</span><span class="token punctuation">(</span><span class="token string">&quot;Received unknown instruction&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token class-name">DataVersionError</span><span class="token punctuation">::</span><span class="token class-name">InvalidInstruction</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre><div class="line-numbers" aria-hidden="true"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br></div></div><!--]--></div><!--]--></div><p>Sau khi xây dựng và áp dụng chỉ thị <code>VersionProgramInstruction::SetString(String)</code>, chúng ta sẽ thấy dữ liệu Account được cập nhật sẽ được sắp xếp như sau:</p><img src="/assets/pav2.1ef612b4.png" alt="Program Account v2"><h2 id="cac-nguon-tai-lieu-khac" tabindex="-1"><a class="header-anchor" href="#cac-nguon-tai-lieu-khac" aria-hidden="true">#</a> <a name="resources"></a> Các nguồn tài liệu khác</h2><ul><li><a href="https://borsh.io/" target="_blank" rel="noopener noreferrer">Mô tả Borsh<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/solana-labs/solana/blob/master/sdk/program/src/borsh.rs#L67" target="_blank" rel="noopener noreferrer">Solana <code>try_from_slice_unchecked</code><span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li><li><a href="https://github.com/FrankC01/versioning-solana" target="_blank" rel="noopener noreferrer">Reference Implementation<span><svg class="external-link-icon" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewbox="0 0 100 100" width="15" height="15"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg><span class="external-link-icon-sr-only">open in new window</span></span></a></li></ul><!--]--></div><footer class="page-meta"><!----><div class="meta-item last-updated"><span class="meta-item-label">Last Updated: </span><!----></div><div class="meta-item contributors"><span class="meta-item-label">Contributors: </span><span class="meta-item-info"><!--[--><!--[--><span class="contributor" title="email: quangtmps12135@fpt.edu.vn">Trần Minh Quang</span><!--[-->, <!--]--><!--]--><!--[--><span class="contributor" title="email: 71456318+tuphan-dn@users.noreply.github.com">tuphan-dn</span><!----><!--]--><!--]--></span></div></footer><nav class="page-nav"><p class="inner"><span class="prev"><a href="/vi/guides/serialization.html" class="" aria-label="Tuần tự hoá dữ liệu"><!--[--><!--]--> Tuần tự hoá dữ liệu <!--[--><!--]--></a></span><span class="next"><a href="/vi/guides/account-maps.html" class="" aria-label="Account Maps"><!--[--><!--]--> Account Maps <!--[--><!--]--></a></span></p></nav><!--[--><!--]--></main><!--]--></div><!----><!--]--></div>
    <script type="module" src="/assets/app.07ce7a66.js" defer></script>
  </body>
</html>
